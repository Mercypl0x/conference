name: Build site

on:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  build:
    runs-on: ubuntu-latest

    env:
      HUGO_VERSION: 0.152.2  # change if you want
      TZ: Europe/Vienna

    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Install Hugo Extended
        run: |
          set -euo pipefail
          curl -sLJO "https://github.com/gohugoio/hugo/releases/download/v${HUGO_VERSION}/hugo_extended_${HUGO_VERSION}_linux-amd64.tar.gz"
          mkdir -p "${HOME}/.local/hugo"
          tar -C "${HOME}/.local/hugo" -xf "hugo_extended_${HUGO_VERSION}_linux-amd64.tar.gz"
          echo "${HOME}/.local/hugo" >> "$GITHUB_PATH"
          hugo version

      - name: Build with Hugo
        run: |
          set -euo pipefail
          hugo --gc --minify

      - name: Generate service worker cache (gencache.sh)
        run: |
          set -euo pipefail
          chmod +x ./gencache.sh
          ./gencache.sh

      - name: Upload public/ as artifact
        uses: actions/upload-artifact@v4
        with:
          name: public
          path: public/
          if-no-files-found: error
